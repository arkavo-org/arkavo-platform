<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Code Collective | Chat</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="Code Collective chat application" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow" />
  <link rel="canonical" href="https://codecollective.us/" />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://codecollective.us/" />
  <meta property="og:site_name" content="Code Collective" />
  <meta property="og:title" content="Code Collective Chat" />
  <meta property="og:description" content="Code Collective chat application" />

  <!-- Favicon -->
  <link rel="icon" href="https://codecollective.us/images/favicons/favicon.png" />

  <link rel="preload" href="https://codecollective.us/css/master.css" as="style">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://codecollective.us/css/master.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./style.css" />

  <!-- Keycloak Script -->
  <script src="https://keycloak.app.codecollective.us/auth/js/keycloak.js"></script>

<body id="body">
  <video id="bg-video" autoplay loop muted playsinline>
    <source src="https://codecollective.us/videos/baltimorenight_15s_crossfaded.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>

  <nav class="main-nav" aria-label="Main Navigation">
    <div class="navbar dark-mode">
      <a href="/#main">Home</a>
      <a href="/balticonomy/">Balticonomy</a>
      <a href="/calendar.html">Calendar</a> 
      <a id="login-btn" href="#">Login</a>
    </div>
  </nav>

  <main id="wrapper" class="longform dark-mode" style="padding: 0; margin: 0;">
    <section id="main" class="longform dark-mode" style="padding: 0; margin: 0;">
      <div class="profile-container">
        <div class="profile-header">
          <img id="profile-pic" class="profile-pic-large" src="https://codecollective.us/images/default-profile.png" alt="Profile Picture">
          <div>
            <h1 id="profile-name">Loading profile...</h1>
            <p id="profile-email"></p>
          </div>
        </div>
        
        <div class="profile-form">
          <div class="form-group">
            <label>Username</label>
            <input id="username" type="text" readonly>
          </div>
          
          <div class="form-group">
            <label>Bio</label>
            <textarea id="bio"></textarea>
          </div>

          <div class="form-group">
            <label>Street Address</label>
            <input id="street" type="text">
          </div>

          <div class="form-group">
            <label>City</label>
            <input id="city" type="text">
          </div>

          <div class="form-group">
            <label>State/Province</label>
            <input id="state" type="text">
          </div>

          <div class="form-group">
            <label>Zip/Postal Code</label>
            <input id="zip" type="text">
          </div>

          <div class="form-group">
            <label>Country</label>
            <input id="country" type="text">
          </div>
          
          <div class="form-actions">
            <button id="save-btn" class="save-btn">Save Profile</button>
            <a href="index.html" class="exit-btn">Back to Chat</a>
            <button id="logout-btn" class="logout-btn">Logout</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <our-footer></our-footer>
  <our-slack-link></our-slack-link>

</body>

<script src="./auth.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {

    try {
        // Fetch user profile data from our new API
        const response = await fetch('https://usres.app.codecollective.us/users/' + keycloak.tokenParsed.preferred_username, {
          headers: {
            'Authorization': `Bearer ${keycloak.token}`
          }
        });
        
        if (!response.ok) throw new Error('Failed to fetch profile');
        
        const profile = await response.json();
        
        // Update profile UI
        const profilePic = document.getElementById('profile-pic');
        profilePic.src = profile.picture || 'https://codecollective.us/images/default-profile.png';
        profilePic.onerror = () => {
          profilePic.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZD0iTTEyLDJBMTAsMTAgMCAwLDAgMiwxMkExMCwxMCAwIDAsMCAxMiwyMkExMCwxMCAwIDAsMCAyMiwxMkExMCwxMCAwIDAsMCAxMiwyTTEyLDRBNyw3IDAgMCwxIDE5LDExQTcsNyAwIDAsMSAxMiwxOEE3LDcgMCAwLDEgNSwxMUE3LDcgMCAwLDEgMTIsNE0xMiw2QTUsNSAwIDAsMCA3LDExQTUsNSAwIDAsMCAxMiwxNkE1LDUgMCAwLDAgMTcsMTFBNSw1IDAgMCwwIDEyLDZNNiwxMkE2LDYgMCAwLDAgMTIsNjhBNiw2IDAgMCwwIDE4LDEyQTUsNSAwIDAsMSAxMiwxN0E1LDUgMCAwLDEgNiwxMloiLz48L3N2Zz4=';
        };
        document.getElementById('profile-name').textContent = profile.name || 'Anonymous';
        document.getElementById('profile-email').textContent = profile.email || '';
        document.getElementById('username').value = profile.username || '';
        document.getElementById('bio').value = profile.bio || 'No bio provided';
        document.getElementById('street').value = profile.street || '';
        document.getElementById('city').value = profile.city || '';
        document.getElementById('state').value = profile.state || '';
        document.getElementById('zip').value = profile.zip_code || '';
        document.getElementById('country').value = profile.country || '';
      
    } catch (error) {
      console.error('Error loading profile:', error);
      document.getElementById('profile-name').textContent = 'Error loading profile';
    }

    // Handle save
    document.getElementById('save-btn').addEventListener('click', async () => {
      try {
        const profileData = {
          username: document.getElementById('username').value,
          email: document.getElementById('profile-email').textContent,
          name: document.getElementById('profile-name').textContent,
          bio: document.getElementById('bio').value,
          street: document.getElementById('street').value,
          city: document.getElementById('city').value,
          state: document.getElementById('state').value,
          zip_code: document.getElementById('zip').value,
          country: document.getElementById('country').value
        };

        const response = await fetch(
          'https://usres.app.codecollective.us/users/' + keycloak.tokenParsed.preferred_username,
          {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${keycloak.token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(profileData)
          }
        );

        if (!response.ok) throw new Error('Failed to save profile');
        alert('Profile saved successfully!');
      } catch (error) {
        console.error('Error saving profile:', error);
        alert('Error saving profile');
      }
    });

    // Handle logout
    document.getElementById('logout-btn').addEventListener('click', () => {
      keycloak.logout();
    });
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</html>
